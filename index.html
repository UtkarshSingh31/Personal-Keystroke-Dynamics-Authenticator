<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Typing Behavior Collector</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      justify-content: center;
      margin-top: 60px;
    }
    .box {
      width: 600px;
    }
    textarea {
      width: 100%;
      height: 150px;
      font-size: 18px;
      padding: 10px;
    }
    button {
      margin-top: 15px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    pre {
      background: #222;
      padding: 10px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2>Type the sentence below</h2>

    <textarea id="inputBox" placeholder="Type here..."></textarea>

    <button onclick="submitData()">Submit</button>

    <h3>Text Typed:</h3>
    <pre id="displayText"></pre>
  </div>

<script>
let keyDownTime = {};
let sequence = [];
let lastReleaseTime = null;
let typedText = "";

const userId = prompt("Enter your user id:");

const inputBox = document.getElementById("inputBox");
const displayText = document.getElementById("displayText");

inputBox.addEventListener("keydown", (e) => {
  const now = performance.now();
  keyDownTime[e.code] = now;
});

inputBox.addEventListener("keyup", (e) => {
  const now = performance.now();
  const pressTime = keyDownTime[e.code];
  if (!pressTime) return;

  const holdTime = (now - pressTime) / 1000;
  const flightTime = lastReleaseTime === null ? 0 : (pressTime - lastReleaseTime) / 1000;
  lastReleaseTime = now;

  let keyName = e.key;

  if (e.key === "Backspace") {
    typedText = typedText.slice(0, -1);
  } else if (e.key.length === 1) {
    typedText += e.key;
  } else if (e.key === "Enter") {
    typedText += "\n";
  } else if (e.key === " ") {
    typedText += " ";
  }

  displayText.textContent = typedText;

  sequence.push({
    key: keyName,
    hold_time: Number(holdTime.toFixed(4)),
    flight_time: Number(flightTime.toFixed(4))
  });

  delete keyDownTime[e.code];
});

function submitData() {
  fetch("http://YOUR_SERVER_IP:8000/submit", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      user_id: Number(userId),
      sequence: sequence,
      text_typed: typedText
    })
  })
  .then(res => res.json())
  .then(data => {
    alert("Saved! Label = " + data.label);
    console.log(data);
  });
}
</script>
</body>
</html>
